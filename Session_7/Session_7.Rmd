---
title: "Code Club Session 7"
author: "Kyle Gontjes"
date: "10/21/2021"
output: html_document
---

## R Markdown Setup Chunk
```{r setup}
require(knitr)
knitr::opts_chunk$set(echo = TRUE,warning = FALSE, message = FALSE) 
knitr::opts_chunk$set(fig.width = 20, fig.height = 9.5)
knitr::opts_chunk$set(comment = NA)
```

## Agenda
0. Set up the R Environment
1. Load the .treefile into R Environment
2. Perform Initial Visualization of the Phylogeny Using the ggtree Package
3. Clean the Phylogeny by Removing Tips and Midpoint Rooting
4. Explore Whether Subseting Tree Based on Sequence Type of Interest is Valuable
5. Subset Tree Based on Sequence Type
6. Visualize Colistin Resistance Using Gheatmap
7. Using ggnewscale to plot heatmap with variables that have different data values

## Part 0: Set up the R Environment
```{r}
# Packages used 
  # Cran R packages
  cran_packages <- c("BiocManager","phytools","ggplot2","tidyverse","readxl","randomcoloR","cowplot")
  # BiocManager packages
  BiocManager_packages <- c("ggtree","ggnewscale")
  
# Functions to install packages (if not installed already)
  # lapply(cran_packages,install.packages,character.only=T)
  # lapply(BiocManager_packages,BiocManager::install,character.only=T)

# Functions to load packages
lapply(cran_packages,library,character.only=T)
lapply(BiocManager_packages,library,character.only=T)
```

## Part 1: Load the .treefile into R Environment
```{r}
# Load .treefile using the ape package
tree <- read.tree(file="")

# Question: What type of object is the .treefile?
class(tree)
# View tree object in R
View(tree)
```

## Part 2: Perform Initial Visualization of the tree Using ggtree
#### See the ggtree full vignette at https://yulab-smu.top/treedata-book/ 
```{r}
# Access the ggtree vignette
vignette("ggtree")

# Visualize tree object using the ggtree function
  # Help page documentation for ggtree function
  help("ggtree")
  # Use ggtree function to view phylogeny
  ggtree(tree)
# Exercise: Add a (1) treescale using geom_treescale and (2) overlay a title using ggtitle 
  
```

## Part 3: Clean the Phylogeny by (1) Removing Tips and (2) Performing Midpoint Rooting
```{r}
# Exercise: Identify the location of the tip labels for this tree

# Drop reference group using the treeio package's drop.tip function

  # View tree without reference group


# Question: Would midpoint rooting be valuable for this phylogeny? 

  # Midpoint root using the phytools rooting tool

  # View midpoint rooted tree again


# Exercise: What is the difference in the tree_wo_root and tree_final? 

  # Bonus Points: Plot the ggtree images side-by-side using your function of choice (cowplot's plot_grid function works wonders) :)
```

## Part 4: Explore Whether Subseting Tree Based on Sequence Type of Interest is Valuable
```{r}
# Import CRKP Metadata
CRKP_metadata <- as.data.frame(read_xlsx(""))

# Exercise: Characterize the dataset
  #1. What are the variables in this dataframe?
  
  #2. How many isolates are in this dataframe?
    #Hint: Each row = a unique isolate
  
  #3. Does the number of isolates in the metadata dataframe equal the number of isolates in the phylogeny?
  
  #4. Does the rownames of the dataframe match the tiplabels in the tree? 

# Create rownames for sorting the dataframe to match the tiplabels of the tree
  
# Subset and sort the dataframe using the match function

# Question: What is the distribution of sequence types within the dataset? 

# Add tips to the tree to visualize distribution of sequence types across the phylogeny
  #Create tip for sequence type

  #Visualize tree with sequence type as tips 
  
  #Question: How is sequence type distributed across the phylogeny?
  
```

## Part 5: Subset Tree Based on Sequence Type
```{r}
# Subset the tree to include only ST258 isolates
  # Create ST258 dataframe using dplyr subset function

  # Subset phylogeny to only include ST258 isolates using drop.tip function

  # Sort dataframe by tip label 
  
# Visualize ST258 phylogeny


# Visualize ST258 phylogeny using different layouts
  # Default

  # Circular

  # Slanted

  # No Branch Length

# Create a tiplabel for Source
  # 1. Tabulate source data

  # 2. Create tip for Source

  # 3. Visualize

  # 4. Store as tree_258_source

# Exercise 1: Create a tip label for Colistin Resistance
  # 1. What regions are there?

  # 2. Create tip for region

  # 3. Visualize and improve size


# Exercise 2: Create a phylogeny with geom_tippoint (1) color = source and (2) shape = colistin resistance

```

## Part 6: Visualize colistin Resistance Using gheatmap
```{r}
# gheatmap Help Page
help("gheatmap")

# Initial gheatmap of Colistin Resistance

# Stepwise formatting of gheatmap
  # Change Heatmap Structure: Angle, Offset, Width, Justification, and Font Size
  
  # Change Heatmap Fill Color and Legend Name: scale_fill_manual
  
  # Change Legend Information: Theme 

# Exersise: Add stored ST258 phylogeny that has source tips to the gheatmap function created above
  # Hint: Format of gheatmap function = gheatmap(phylogeny, data, ...) :)

```

## Part 7: Using ggnewscale to plot heatmap with variables that have different data structures
```{r}
#Exercise: Plot Source and resistance (Colistin) in the same gheatmap

  #Question: What is 'wrong' about the figure above? How can you fix it? 

#Introducing ggnewscale!
help("ggnewscale")

# Generate of Unique Colors
  # Introducing randomcoloR::distinctColorPalette!
  ??randomcoloR::distinctColorPalette
  # Generate a color pallete using the distinctColorPallete function

  # View color palette chosen

# Generate Heatmap Using ggnewscale
  # Phylogeny with source heatmap column

  # Use new_scale_fill to add new scale for upcoming heatmap columns

  # Add resistance column to heatmap

```